–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è @Transactional –≤ Java –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Spring Framework –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:

–û–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–∞ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. 
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è (rollback).
–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

–ù–∞ —É—Ä–æ–≤–Ω–µ –º–µ—Ç–æ–¥–æ–≤ –∏–ª–∏ –∫–ª–∞—Å—Å–æ–≤ (–æ–±—ã—á–Ω–æ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö).
–ü—Ä–∏–º–µ—Ä:

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class UserService {

    @Transactional
    public void registerUser(User user) {
        userRepository.save(user);
        emailService.sendWelcomeEmail(user); // –µ—Å–ª–∏ –∑–¥–µ—Å—å –≤—ã–±—Ä–æ—Å–∏—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, save –æ—Ç–∫–∞—Ç–∏—Ç—Å—è
    }
}

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

    readOnly = true ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤).

    rollbackFor = Exception.class ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç, –ø—Ä–∏ –∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö –¥–µ–ª–∞—Ç—å –æ—Ç–∫–∞—Ç.

    propagation = Propagation.REQUIRED ‚Äî –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

    isolation = Isolation.READ_COMMITTED ‚Äî —É—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:

    –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –ø—Ä–æ–∫—Å–∏ –∏ –±–∏–Ω–∞–º–∏ Spring.

    –ù–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –º–µ—Ç–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–æ–≥–æ –∂–µ –∫–ª–∞—Å—Å–∞ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≤—ã–∑–æ–≤ –Ω–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏).

–•–æ—á–µ—à—å —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫ @Transactional —Ä–∞–±–æ—Ç–∞–µ—Ç —Å rollback –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ?
–í—ã —Å–∫–∞–∑–∞–ª–∏:
 –∫–∞–∫ @Transactional —Ä–∞–±–æ—Ç–∞–µ—Ç —Å rollback –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ?


–í–æ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä, –∫–∞–∫ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è @Transactional –≤ Spring –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç–∫–∞—Ç (rollback) –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏:
üì¶ –ü—Ä–∏–º–µ—Ä: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private LogRepository logRepository;

    @Transactional
    public void registerUser(String username) {
        User user = new User(username);
        userRepository.save(user); // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        // –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        if (true) {
            throw new RuntimeException("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏");
        }

        logRepository.save(new Log("User registered: " + username)); // ‚ùå –ù–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
    }
}

üîç –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç:

    userRepository.save() –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è, –Ω–æ –Ω–µ –±—É–¥–µ—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ (committed).

    –ü—Ä–∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–Ω–∏–∏ RuntimeException –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç rollback –≤—Å–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

    –ù–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –Ω–∏ –ª–æ–≥ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑–µ.

üìå –í–∞–∂–Ω–æ:

    –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é Spring –¥–µ–ª–∞–µ—Ç rollback —Ç–æ–ª—å–∫–æ –Ω–∞ RuntimeException –∏–ª–∏ Error.

    –î–ª—è rollback –Ω–∞ checked exception –Ω—É–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å:

@Transactional(rollbackFor = YourCheckedException.class)


‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –æ—Ç–∫–∞—Ç–æ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private LogRepository logRepository;

    @Transactional
    public void registerUser(String username) {
        try {
            User user = new User(username);
            userRepository.save(user); // –ú–æ–∂–µ—Ç –≤—ã–±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

            logRepository.save(new Log("User registered: " + username));
        } catch (Exception e) {
            // –õ–æ–≥–∏—Ä—É–µ–º, –Ω–æ –Ω–µ –ø–æ–¥–∞–≤–ª—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
            System.err.println("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + e.getMessage());
            throw e; // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –±—ã–ª rollback
        }
    }
}

‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:

    –ù–µ –ø–æ–¥–∞–≤–ª—è–π –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ catch, –∏–Ω–∞—á–µ Spring –ø–æ–¥—É–º–∞–µ—Ç, —á—Ç–æ –≤—Å—ë –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ.

    @Transactional –¥–æ–ª–∂–µ–Ω —Å—Ç–æ—è—Ç—å –Ω–∞ –ø—É–±–ª–∏—á–Ω–æ–º –º–µ—Ç–æ–¥–µ, –≤—ã–∑—ã–≤–∞–µ–º–æ–º –∏–∑–≤–Ω–µ (—á–µ—Ä–µ–∑ Spring-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä).

    –ï—Å–ª–∏ save –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç RuntimeException, rollback –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

=========================================================


‚úÖ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è @Transactional –≤ Java (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Spring):

–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è @Transactional —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –º–µ—Ç–æ–¥ –∏–ª–∏ –∫–ª–∞—Å—Å –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
üîÅ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

    –ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –º–µ—Ç–æ–¥ —Å @Transactional, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è.

    –í–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (insert, update, delete –∏ —Ç.–¥.).

    –ï—Å–ª–∏ –≤—Å—ë –ø—Ä–æ—à–ª–æ –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π (–æ—à–∏–±–æ–∫) ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è commit'–∏—Ç—Å—è (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è).

    –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ –Ω–µ–ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, RuntimeException) ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è (rollback).

üìå –ü—Ä–∏–º–µ—Ä:

@Service
public class UserService {

    @Transactional
    public void createUserAndProfile(User user, Profile profile) {
        userRepository.save(user);
        profileRepository.save(profile);
    }
}

üîπ –ï—Å–ª–∏ save(user) –∏–ª–∏ save(profile) –≤—ã–±—Ä–æ—Å–∏—Ç –æ—à–∏–±–∫—É ‚Äî –æ–±–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, —Ç.–∫. –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç rollback.
‚ö†Ô∏è –í–∞–∂–Ω–æ:

    –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é rollback –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ unchecked exceptions (RuntimeException –∏ –∏—Ö –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞—Ö).
    –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å –∏ –ø—Ä–∏ checked exceptions ‚Äî –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —è–≤–Ω–æ:

    @Transactional(rollbackFor = Exception.class)

    @Transactional —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:

        –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ –∏–¥—ë—Ç —á–µ—Ä–µ–∑ Spring Proxy.

        –ú–µ—Ç–æ–¥ –ø—É–±–ª–∏—á–Ω—ã–π.

        Spring Context –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ (@EnableTransactionManagement –∏–ª–∏ auto-config).

üìå –í—ã–≤–æ–¥:

üî∏ @Transactional ‚Äî —ç—Ç–æ –Ω–µ–∫–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ö–∞–Ω–∏–∑–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.
üî∏ commit –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –º–µ—Ç–æ–¥ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ.
üî∏ rollback ‚Äî –µ—Å–ª–∏ –±—ã–ª–∞ –æ—à–∏–±–∫–∞.



